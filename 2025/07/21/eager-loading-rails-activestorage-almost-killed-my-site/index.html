<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="max-image-preview:large">
	<style>img:is([sizes="auto" i], [sizes^="auto," i]) { contain-intrinsic-size: 3000px 1500px }</style>
	<title>Eager loading Rails ActiveStorage Variants Almost Killed My Site &ndash; aldavigdis.dev</title>
<link rel="alternate" type="application/rss+xml" title="aldavigdis.dev &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="aldavigdis.dev &raquo; Comments Feed" href="/comments/feed/">
<script>
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/16.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/16.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.8.3"}};
/*! This file is auto-generated */
!function(s,n){var o,i,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),a=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===a[t]})}function u(e,t){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);for(var n=e.getImageData(16,16,1,1),a=0;a<n.data.length;a++)if(0!==n.data[a])return!1;return!0}function f(e,t,n,a){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\udde8\ud83c\uddf6","\ud83c\udde8\u200b\ud83c\uddf6")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!a(e,"\ud83e\udedf")}return!1}function g(e,t,n,a){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):s.createElement("canvas"),o=r.getContext("2d",{willReadFrequently:!0}),i=(o.textBaseline="top",o.font="600 32px Arial",{});return e.forEach(function(e){i[e]=t(o,e,n,a)}),i}function t(e){var t=s.createElement("script");t.src=e,t.defer=!0,s.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",i=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){s.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+g.toString()+"("+[JSON.stringify(i),f.toString(),p.toString(),u.toString()].join(",")+"));",a=new Blob([e],{type:"text/javascript"}),r=new Worker(URL.createObjectURL(a),{name:"wpTestEmojiSupports"});return void(r.onmessage=function(e){c(n=e.data),r.terminate(),t(n)})}catch(e){}c(n=g(i,f,p,u))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
</script>
<style id="wp-block-site-title-inline-css">
.wp-block-site-title{box-sizing:border-box}.wp-block-site-title :where(a){color:inherit;font-family:inherit;font-size:inherit;font-style:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;text-decoration:inherit}
</style>
<style id="wp-block-template-part-theme-inline-css">
:root :where(.wp-block-template-part.has-background){margin-bottom:0;margin-top:0;padding:1.25em 2.375em}
</style>
<style id="wp-block-post-title-inline-css">
.wp-block-post-title{box-sizing:border-box;word-break:break-word}.wp-block-post-title :where(a){display:inline-block;font-family:inherit;font-size:inherit;font-style:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;text-decoration:inherit}
</style>
<style id="wp-block-post-date-inline-css">
.wp-block-post-date{box-sizing:border-box}
</style>
<style id="wp-block-post-featured-image-inline-css">
.wp-block-post-featured-image{margin-left:0;margin-right:0}.wp-block-post-featured-image a{display:block;height:100%}.wp-block-post-featured-image :where(img){box-sizing:border-box;height:auto;max-width:100%;vertical-align:bottom;width:100%}.wp-block-post-featured-image.alignfull img,.wp-block-post-featured-image.alignwide img{width:100%}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim{background-color:#000;inset:0;position:absolute}.wp-block-post-featured-image{position:relative}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-gradient{background-color:initial}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-0{opacity:0}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-10{opacity:.1}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-20{opacity:.2}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-30{opacity:.3}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-40{opacity:.4}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-50{opacity:.5}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-60{opacity:.6}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-70{opacity:.7}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-80{opacity:.8}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-90{opacity:.9}.wp-block-post-featured-image .wp-block-post-featured-image__overlay.has-background-dim-100{opacity:1}.wp-block-post-featured-image:where(.alignleft,.alignright){width:100%}
</style>
<style id="wp-block-paragraph-inline-css">
.is-small-text{font-size:.875em}.is-regular-text{font-size:1em}.is-large-text{font-size:2.25em}.is-larger-text{font-size:3em}.has-drop-cap:not(:focus):first-letter{float:left;font-size:8.4em;font-style:normal;font-weight:100;line-height:.68;margin:.05em .1em 0 0;text-transform:uppercase}body.rtl .has-drop-cap:not(:focus):first-letter{float:none;margin-left:.1em}p.has-drop-cap.has-background{overflow:hidden}:root :where(p.has-background){padding:1.25em 2.375em}:where(p.has-text-color:not(.has-link-color)) a{color:inherit}p.has-text-align-left[style*="writing-mode:vertical-lr"],p.has-text-align-right[style*="writing-mode:vertical-rl"]{rotate:180deg}
</style>
<style id="wp-block-heading-inline-css">
h1.has-background,h2.has-background,h3.has-background,h4.has-background,h5.has-background,h6.has-background{padding:1.25em 2.375em}h1.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h1.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h2.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h2.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h3.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h3.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h4.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h4.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h5.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h5.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h6.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h6.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]){rotate:180deg}
</style>
<style id="wp-block-code-inline-css">
.wp-block-code{box-sizing:border-box}.wp-block-code code{
  /*!rtl:begin:ignore*/direction:ltr;display:block;font-family:inherit;overflow-wrap:break-word;text-align:initial;white-space:pre-wrap
  /*!rtl:end:ignore*/}
</style>
<style id="wp-block-code-theme-inline-css">
.wp-block-code{border:1px solid #ccc;border-radius:4px;font-family:Menlo,Consolas,monaco,monospace;padding:.8em 1em}
</style>
<style id="wp-block-image-inline-css">
.wp-block-image>a,.wp-block-image>figure>a{display:inline-block}.wp-block-image img{box-sizing:border-box;height:auto;max-width:100%;vertical-align:bottom}@media not (prefers-reduced-motion){.wp-block-image img.hide{visibility:hidden}.wp-block-image img.show{animation:show-content-image .4s}}.wp-block-image[style*=border-radius] img,.wp-block-image[style*=border-radius]>a{border-radius:inherit}.wp-block-image.has-custom-border img{box-sizing:border-box}.wp-block-image.aligncenter{text-align:center}.wp-block-image.alignfull>a,.wp-block-image.alignwide>a{width:100%}.wp-block-image.alignfull img,.wp-block-image.alignwide img{height:auto;width:100%}.wp-block-image .aligncenter,.wp-block-image .alignleft,.wp-block-image .alignright,.wp-block-image.aligncenter,.wp-block-image.alignleft,.wp-block-image.alignright{display:table}.wp-block-image .aligncenter>figcaption,.wp-block-image .alignleft>figcaption,.wp-block-image .alignright>figcaption,.wp-block-image.aligncenter>figcaption,.wp-block-image.alignleft>figcaption,.wp-block-image.alignright>figcaption{caption-side:bottom;display:table-caption}.wp-block-image .alignleft{float:left;margin:.5em 1em .5em 0}.wp-block-image .alignright{float:right;margin:.5em 0 .5em 1em}.wp-block-image .aligncenter{margin-left:auto;margin-right:auto}.wp-block-image :where(figcaption){margin-bottom:1em;margin-top:.5em}.wp-block-image.is-style-circle-mask img{border-radius:9999px}@supports ((-webkit-mask-image:none) or (mask-image:none)) or (-webkit-mask-image:none){.wp-block-image.is-style-circle-mask img{border-radius:0;-webkit-mask-image:url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/>');mask-image:url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/>');mask-mode:alpha;-webkit-mask-position:center;mask-position:center;-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:contain;mask-size:contain}}:root :where(.wp-block-image.is-style-rounded img,.wp-block-image .is-style-rounded img){border-radius:9999px}.wp-block-image figure{margin:0}.wp-lightbox-container{display:flex;flex-direction:column;position:relative}.wp-lightbox-container img{cursor:zoom-in}.wp-lightbox-container img:hover+button{opacity:1}.wp-lightbox-container button{align-items:center;-webkit-backdrop-filter:blur(16px) saturate(180%);backdrop-filter:blur(16px) saturate(180%);background-color:#5a5a5a40;border:none;border-radius:4px;cursor:zoom-in;display:flex;height:20px;justify-content:center;opacity:0;padding:0;position:absolute;right:16px;text-align:center;top:16px;width:20px;z-index:100}@media not (prefers-reduced-motion){.wp-lightbox-container button{transition:opacity .2s ease}}.wp-lightbox-container button:focus-visible{outline:3px auto #5a5a5a40;outline:3px auto -webkit-focus-ring-color;outline-offset:3px}.wp-lightbox-container button:hover{cursor:pointer;opacity:1}.wp-lightbox-container button:focus{opacity:1}.wp-lightbox-container button:focus,.wp-lightbox-container button:hover,.wp-lightbox-container button:not(:hover):not(:active):not(.has-background){background-color:#5a5a5a40;border:none}.wp-lightbox-overlay{box-sizing:border-box;cursor:zoom-out;height:100vh;left:0;overflow:hidden;position:fixed;top:0;visibility:hidden;width:100%;z-index:100000}.wp-lightbox-overlay .close-button{align-items:center;cursor:pointer;display:flex;justify-content:center;min-height:40px;min-width:40px;padding:0;position:absolute;right:calc(env(safe-area-inset-right) + 16px);top:calc(env(safe-area-inset-top) + 16px);z-index:5000000}.wp-lightbox-overlay .close-button:focus,.wp-lightbox-overlay .close-button:hover,.wp-lightbox-overlay .close-button:not(:hover):not(:active):not(.has-background){background:none;border:none}.wp-lightbox-overlay .lightbox-image-container{height:var(--wp--lightbox-container-height);left:50%;overflow:hidden;position:absolute;top:50%;transform:translate(-50%,-50%);transform-origin:top left;width:var(--wp--lightbox-container-width);z-index:9999999999}.wp-lightbox-overlay .wp-block-image{align-items:center;box-sizing:border-box;display:flex;height:100%;justify-content:center;margin:0;position:relative;transform-origin:0 0;width:100%;z-index:3000000}.wp-lightbox-overlay .wp-block-image img{height:var(--wp--lightbox-image-height);min-height:var(--wp--lightbox-image-height);min-width:var(--wp--lightbox-image-width);width:var(--wp--lightbox-image-width)}.wp-lightbox-overlay .wp-block-image figcaption{display:none}.wp-lightbox-overlay button{background:none;border:none}.wp-lightbox-overlay .scrim{background-color:#fff;height:100%;opacity:.9;position:absolute;width:100%;z-index:2000000}.wp-lightbox-overlay.active{visibility:visible}@media not (prefers-reduced-motion){.wp-lightbox-overlay.active{animation:turn-on-visibility .25s both}.wp-lightbox-overlay.active img{animation:turn-on-visibility .35s both}.wp-lightbox-overlay.show-closing-animation:not(.active){animation:turn-off-visibility .35s both}.wp-lightbox-overlay.show-closing-animation:not(.active) img{animation:turn-off-visibility .25s both}.wp-lightbox-overlay.zoom.active{animation:none;opacity:1;visibility:visible}.wp-lightbox-overlay.zoom.active .lightbox-image-container{animation:lightbox-zoom-in .4s}.wp-lightbox-overlay.zoom.active .lightbox-image-container img{animation:none}.wp-lightbox-overlay.zoom.active .scrim{animation:turn-on-visibility .4s forwards}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active){animation:none}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active) .lightbox-image-container{animation:lightbox-zoom-out .4s}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active) .lightbox-image-container img{animation:none}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active) .scrim{animation:turn-off-visibility .4s forwards}}@keyframes show-content-image{0%{visibility:hidden}99%{visibility:hidden}to{visibility:visible}}@keyframes turn-on-visibility{0%{opacity:0}to{opacity:1}}@keyframes turn-off-visibility{0%{opacity:1;visibility:visible}99%{opacity:0;visibility:visible}to{opacity:0;visibility:hidden}}@keyframes lightbox-zoom-in{0%{transform:translate(calc((-100vw + var(--wp--lightbox-scrollbar-width))/2 + var(--wp--lightbox-initial-left-position)),calc(-50vh + var(--wp--lightbox-initial-top-position))) scale(var(--wp--lightbox-scale))}to{transform:translate(-50%,-50%) scale(1)}}@keyframes lightbox-zoom-out{0%{transform:translate(-50%,-50%) scale(1);visibility:visible}99%{visibility:visible}to{transform:translate(calc((-100vw + var(--wp--lightbox-scrollbar-width))/2 + var(--wp--lightbox-initial-left-position)),calc(-50vh + var(--wp--lightbox-initial-top-position))) scale(var(--wp--lightbox-scale));visibility:hidden}}
</style>
<style id="wp-block-image-theme-inline-css">
:root :where(.wp-block-image figcaption){color:#555;font-size:13px;text-align:center}.is-dark-theme :root :where(.wp-block-image figcaption){color:#ffffffa6}.wp-block-image{margin:0 0 1em}
</style>
<style id="wp-block-quote-inline-css">
.wp-block-quote{box-sizing:border-box;overflow-wrap:break-word}.wp-block-quote.is-large:where(:not(.is-style-plain)),.wp-block-quote.is-style-large:where(:not(.is-style-plain)){margin-bottom:1em;padding:0 1em}.wp-block-quote.is-large:where(:not(.is-style-plain)) p,.wp-block-quote.is-style-large:where(:not(.is-style-plain)) p{font-size:1.5em;font-style:italic;line-height:1.6}.wp-block-quote.is-large:where(:not(.is-style-plain)) cite,.wp-block-quote.is-large:where(:not(.is-style-plain)) footer,.wp-block-quote.is-style-large:where(:not(.is-style-plain)) cite,.wp-block-quote.is-style-large:where(:not(.is-style-plain)) footer{font-size:1.125em;text-align:right}.wp-block-quote>cite{display:block}
</style>
<style id="wp-block-quote-theme-inline-css">
.wp-block-quote{border-left:.25em solid;margin:0 0 1.75em;padding-left:1em}.wp-block-quote cite,.wp-block-quote footer{color:currentColor;font-size:.8125em;font-style:normal;position:relative}.wp-block-quote:where(.has-text-align-right){border-left:none;border-right:.25em solid;padding-left:0;padding-right:1em}.wp-block-quote:where(.has-text-align-center){border:none;padding-left:0}.wp-block-quote.is-large,.wp-block-quote.is-style-large,.wp-block-quote:where(.is-style-plain){border:none}
</style>
<style id="wp-block-post-content-inline-css">
.wp-block-post-content{display:flow-root}
</style>
<style id="wp-block-group-inline-css">
.wp-block-group{box-sizing:border-box}:where(.wp-block-group.wp-block-group-is-layout-constrained){position:relative}
</style>
<style id="wp-block-group-theme-inline-css">
:where(.wp-block-group.has-background){padding:1.25em 2.375em}
</style>
<style id="wp-block-post-author-inline-css">
.wp-block-post-author{box-sizing:border-box;display:flex;flex-wrap:wrap}.wp-block-post-author__byline{font-size:.5em;margin-bottom:0;margin-top:0;width:100%}.wp-block-post-author__avatar{margin-right:1em}.wp-block-post-author__bio{font-size:.7em;margin-bottom:.7em}.wp-block-post-author__content{flex-basis:0;flex-grow:1}.wp-block-post-author__name{margin:0}
</style>
<style id="wp-emoji-styles-inline-css">

	img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}
</style>
<style id="wp-block-library-inline-css">
:root{--wp-admin-theme-color:#007cba;--wp-admin-theme-color--rgb:0,124,186;--wp-admin-theme-color-darker-10:#006ba1;--wp-admin-theme-color-darker-10--rgb:0,107,161;--wp-admin-theme-color-darker-20:#005a87;--wp-admin-theme-color-darker-20--rgb:0,90,135;--wp-admin-border-width-focus:2px;--wp-block-synced-color:#7a00df;--wp-block-synced-color--rgb:122,0,223;--wp-bound-block-color:var(--wp-block-synced-color)}@media (min-resolution:192dpi){:root{--wp-admin-border-width-focus:1.5px}}.wp-element-button{cursor:pointer}:root{--wp--preset--font-size--normal:16px;--wp--preset--font-size--huge:42px}:root .has-very-light-gray-background-color{background-color:#eee}:root .has-very-dark-gray-background-color{background-color:#313131}:root .has-very-light-gray-color{color:#eee}:root .has-very-dark-gray-color{color:#313131}:root .has-vivid-green-cyan-to-vivid-cyan-blue-gradient-background{background:linear-gradient(135deg,#00d084,#0693e3)}:root .has-purple-crush-gradient-background{background:linear-gradient(135deg,#34e2e4,#4721fb 50%,#ab1dfe)}:root .has-hazy-dawn-gradient-background{background:linear-gradient(135deg,#faaca8,#dad0ec)}:root .has-subdued-olive-gradient-background{background:linear-gradient(135deg,#fafae1,#67a671)}:root .has-atomic-cream-gradient-background{background:linear-gradient(135deg,#fdd79a,#004a59)}:root .has-nightshade-gradient-background{background:linear-gradient(135deg,#330968,#31cdcf)}:root .has-midnight-gradient-background{background:linear-gradient(135deg,#020381,#2874fc)}.has-regular-font-size{font-size:1em}.has-larger-font-size{font-size:2.625em}.has-normal-font-size{font-size:var(--wp--preset--font-size--normal)}.has-huge-font-size{font-size:var(--wp--preset--font-size--huge)}.has-text-align-center{text-align:center}.has-text-align-left{text-align:left}.has-text-align-right{text-align:right}#end-resizable-editor-section{display:none}.aligncenter{clear:both}.items-justified-left{justify-content:flex-start}.items-justified-center{justify-content:center}.items-justified-right{justify-content:flex-end}.items-justified-space-between{justify-content:space-between}.screen-reader-text{border:0;clip-path:inset(50%);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px;word-wrap:normal!important}.screen-reader-text:focus{background-color:#ddd;clip-path:none;color:#444;display:block;font-size:1em;height:auto;left:5px;line-height:normal;padding:15px 23px 14px;text-decoration:none;top:5px;width:auto;z-index:100000}html :where(.has-border-color){border-style:solid}html :where([style*=border-top-color]){border-top-style:solid}html :where([style*=border-right-color]){border-right-style:solid}html :where([style*=border-bottom-color]){border-bottom-style:solid}html :where([style*=border-left-color]){border-left-style:solid}html :where([style*=border-width]){border-style:solid}html :where([style*=border-top-width]){border-top-style:solid}html :where([style*=border-right-width]){border-right-style:solid}html :where([style*=border-bottom-width]){border-bottom-style:solid}html :where([style*=border-left-width]){border-left-style:solid}html :where(img[class*=wp-image-]){height:auto;max-width:100%}:where(figure){margin:0 0 1em}html :where(.is-position-sticky){--wp-admin--admin-bar--position-offset:var(--wp-admin--admin-bar--height,0px)}@media screen and (max-width:600px){html :where(.is-position-sticky){--wp-admin--admin-bar--position-offset:0px}}
</style>
<link rel="stylesheet" id="aldatheme_style-css" href="/wp-content/themes/aldatheme/style.css?ver=0.1.4-2025-10-06" media="all">
<style id="global-styles-inline-css">
:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--color--almost-black: #333;--wp--preset--color--light-grey: #F0F0F4;--wp--preset--color--grey: #ccc;--wp--preset--color--dark-grey: #555;--wp--preset--color--magenta: #dc68dc;--wp--preset--color--magenta-alt: #dc68a2;--wp--preset--color--orange: #dca268;--wp--preset--color--green: #a2dc68;--wp--preset--color--pastel-magenta: #fff0ff;--wp--preset--color--pastel-magenta-alt: #fff0f8;--wp--preset--color--pastel-orange: #fff8f0;--wp--preset--color--pastel-yellow: #fffff0;--wp--preset--color--pastel-green: #f8fff0;--wp--preset--color--dark-magenta: #6a256a;--wp--preset--color--dark-magenta-alt: #6a2548;--wp--preset--color--dark-orange: #6a4825;--wp--preset--color--dark-yellow: #6a6a25;--wp--preset--color--dark-green: #486a25;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--gradient--tequila-sunrise: linear-gradient(var(--wp--preset--color--magenta-alt) 33%, var(--wp--preset--color--orange) 133% );--wp--preset--gradient--queer-cocktail: linear-gradient(var(--wp--preset--color--magenta-alt) 0%, var(--wp--preset--color--magenta) 100%);--wp--preset--font-size--small: 12px;--wp--preset--font-size--medium: 16px;--wp--preset--font-size--large: 42px;--wp--preset--font-size--x-large: 72px;--wp--preset--font-family--libre-baskerville: Libre Baskerville, serif;--wp--preset--font-family--bitter: Bitter, serif;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:root { --wp--style--global--content-size: 840px;--wp--style--global--wide-size: 1100px; }:where(body) { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}.is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}.is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}.is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}.is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}.is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}.is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}.is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}.is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}body{padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 0px;}a:where(:not(.wp-element-button)){text-decoration: underline;}:root :where(.wp-element-button, .wp-block-button__link){background-color: #32373c;border-width: 0;color: #fff;font-family: inherit;font-size: inherit;line-height: inherit;padding: calc(0.667em + 2px) calc(1.333em + 2px);text-decoration: none;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-almost-black-color{color: var(--wp--preset--color--almost-black) !important;}.has-light-grey-color{color: var(--wp--preset--color--light-grey) !important;}.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-dark-grey-color{color: var(--wp--preset--color--dark-grey) !important;}.has-magenta-color{color: var(--wp--preset--color--magenta) !important;}.has-magenta-alt-color{color: var(--wp--preset--color--magenta-alt) !important;}.has-orange-color{color: var(--wp--preset--color--orange) !important;}.has-green-color{color: var(--wp--preset--color--green) !important;}.has-pastel-magenta-color{color: var(--wp--preset--color--pastel-magenta) !important;}.has-pastel-magenta-alt-color{color: var(--wp--preset--color--pastel-magenta-alt) !important;}.has-pastel-orange-color{color: var(--wp--preset--color--pastel-orange) !important;}.has-pastel-yellow-color{color: var(--wp--preset--color--pastel-yellow) !important;}.has-pastel-green-color{color: var(--wp--preset--color--pastel-green) !important;}.has-dark-magenta-color{color: var(--wp--preset--color--dark-magenta) !important;}.has-dark-magenta-alt-color{color: var(--wp--preset--color--dark-magenta-alt) !important;}.has-dark-orange-color{color: var(--wp--preset--color--dark-orange) !important;}.has-dark-yellow-color{color: var(--wp--preset--color--dark-yellow) !important;}.has-dark-green-color{color: var(--wp--preset--color--dark-green) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-almost-black-background-color{background-color: var(--wp--preset--color--almost-black) !important;}.has-light-grey-background-color{background-color: var(--wp--preset--color--light-grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-dark-grey-background-color{background-color: var(--wp--preset--color--dark-grey) !important;}.has-magenta-background-color{background-color: var(--wp--preset--color--magenta) !important;}.has-magenta-alt-background-color{background-color: var(--wp--preset--color--magenta-alt) !important;}.has-orange-background-color{background-color: var(--wp--preset--color--orange) !important;}.has-green-background-color{background-color: var(--wp--preset--color--green) !important;}.has-pastel-magenta-background-color{background-color: var(--wp--preset--color--pastel-magenta) !important;}.has-pastel-magenta-alt-background-color{background-color: var(--wp--preset--color--pastel-magenta-alt) !important;}.has-pastel-orange-background-color{background-color: var(--wp--preset--color--pastel-orange) !important;}.has-pastel-yellow-background-color{background-color: var(--wp--preset--color--pastel-yellow) !important;}.has-pastel-green-background-color{background-color: var(--wp--preset--color--pastel-green) !important;}.has-dark-magenta-background-color{background-color: var(--wp--preset--color--dark-magenta) !important;}.has-dark-magenta-alt-background-color{background-color: var(--wp--preset--color--dark-magenta-alt) !important;}.has-dark-orange-background-color{background-color: var(--wp--preset--color--dark-orange) !important;}.has-dark-yellow-background-color{background-color: var(--wp--preset--color--dark-yellow) !important;}.has-dark-green-background-color{background-color: var(--wp--preset--color--dark-green) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-almost-black-border-color{border-color: var(--wp--preset--color--almost-black) !important;}.has-light-grey-border-color{border-color: var(--wp--preset--color--light-grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}.has-dark-grey-border-color{border-color: var(--wp--preset--color--dark-grey) !important;}.has-magenta-border-color{border-color: var(--wp--preset--color--magenta) !important;}.has-magenta-alt-border-color{border-color: var(--wp--preset--color--magenta-alt) !important;}.has-orange-border-color{border-color: var(--wp--preset--color--orange) !important;}.has-green-border-color{border-color: var(--wp--preset--color--green) !important;}.has-pastel-magenta-border-color{border-color: var(--wp--preset--color--pastel-magenta) !important;}.has-pastel-magenta-alt-border-color{border-color: var(--wp--preset--color--pastel-magenta-alt) !important;}.has-pastel-orange-border-color{border-color: var(--wp--preset--color--pastel-orange) !important;}.has-pastel-yellow-border-color{border-color: var(--wp--preset--color--pastel-yellow) !important;}.has-pastel-green-border-color{border-color: var(--wp--preset--color--pastel-green) !important;}.has-dark-magenta-border-color{border-color: var(--wp--preset--color--dark-magenta) !important;}.has-dark-magenta-alt-border-color{border-color: var(--wp--preset--color--dark-magenta-alt) !important;}.has-dark-orange-border-color{border-color: var(--wp--preset--color--dark-orange) !important;}.has-dark-yellow-border-color{border-color: var(--wp--preset--color--dark-yellow) !important;}.has-dark-green-border-color{border-color: var(--wp--preset--color--dark-green) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-tequila-sunrise-gradient-background{background: var(--wp--preset--gradient--tequila-sunrise) !important;}.has-queer-cocktail-gradient-background{background: var(--wp--preset--gradient--queer-cocktail) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}.has-libre-baskerville-font-family{font-family: var(--wp--preset--font-family--libre-baskerville) !important;}.has-bitter-font-family{font-family: var(--wp--preset--font-family--bitter) !important;}
</style>
<style id="wp-block-template-skip-link-inline-css">

		.skip-link.screen-reader-text {
			border: 0;
			clip-path: inset(50%);
			height: 1px;
			margin: -1px;
			overflow: hidden;
			padding: 0;
			position: absolute !important;
			width: 1px;
			word-wrap: normal !important;
		}

		.skip-link.screen-reader-text:focus {
			background-color: #eee;
			clip-path: none;
			color: #444;
			display: block;
			font-size: 1em;
			height: auto;
			left: 5px;
			line-height: normal;
			padding: 15px 23px 14px;
			text-decoration: none;
			top: 5px;
			width: auto;
			z-index: 100000;
		}
</style>
<link rel="stylesheet" id="mkaz-code-syntax-prism-css-css" href="/wp-content/plugins/code-syntax-block/assets/prism-a11y-dark.css?ver=1727704537" media="all">
<link rel="https://api.w.org/" href="/wp-json/"><link rel="alternate" title="JSON" type="application/json" href="/wp-json/wp/v2/posts/740"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.8.3">
<link rel="canonical" href="/2025/07/21/eager-loading-rails-activestorage-almost-killed-my-site/">
<link rel="shortlink" href="/?p=740">
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2025%2F07%2F21%2Feager-loading-rails-activestorage-almost-killed-my-site%2F">
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2025%2F07%2F21%2Feager-loading-rails-activestorage-almost-killed-my-site%2F&amp;format=xml">
</head>

<body class="wp-singular post-template-default single single-post postid-740 single-format-standard wp-embed-responsive wp-theme-aldatheme">

<div class="wp-site-blocks"><header class="site-header wp-block-template-part"><p class="wp-block-site-title has-large-font-size"><a href="/" target="_self" rel="home">aldavigdis.dev</a></p></header>


    <article class="wp-block-group main-content is-layout-flow wp-block-group-is-layout-flow">
    <h2 class="wp-block-post-title">Eager loading Rails ActiveStorage Variants Almost Killed My Site</h2>
    
    <div class="wp-block-post-date"><time datetime="2025-07-21T11:14:48+00:00">July 21, 2025</time></div>
    
    
    
    <div class="entry-content wp-block-post-content is-layout-flow wp-block-post-content-is-layout-flow">
<p>For the past couple of years, I have been running the technical side of the annual <a href="https://www.bokatidindi.is/" target="_blank" rel="noreferrer noopener">Icelandic Book Catalogue</a>, which is not only a website as its printed edition has been delivered to Icelandic households for the past century and marks the beginning of the Christmas book sales season for many.</p>



<p>The project has been an interesting exercise in web application performance and what I call &ldquo;sensible scalability&rdquo; as both visitor traffic and data entry are highly seasonal. It also relates to my print design background as it provides <abbr title="Extensible Markup Language">XML</abbr> data for use in InDesign using a PowerShell based utility.</p>



<p>Now that it is the off-season and I was upgrading the Ruby on Rails version for the site from 7.0 to 8.0, which was long-overdue, I came across a sudden, but serious performance bottleneck that was choking the system.</p>



<p>Suddenly, rendering a list of books, which usually took less than 200 ms was taking up to 1200 ms and important endpoints that 3rd parties use were timing out completely and maxing out server resources.</p>



<p>Our Heroku dynos were crashing. I was burning the midnight oil and there were no changes to my own codebase that could explain this.</p>



<h2 class="wp-block-heading">A Bit of Technical Background</h2>



<p>If you are a Rails developer or someone who has used any other <abbr title="model-view-controller">MVC</abbr> framework with a good <abbr title="Object&ndash;relational mapping">ORM</abbr> library instead of writing your SQL statements manually like a caveman, you&rsquo;ve come across the concept of <em>n+1 queries</em>, which are generally considered to be something to avoid if performance and scalability are important to you.</p>



<p>The general idea is that you really don&rsquo;t want to iterate through database results in your app and then send in another database query for each results for relational data. You want to fetch as much information as you can in as few queries as possible to save overhead and reduce the time to takes to fetch and present your data.</p>



<p>If you need a refresher, an ORM is a part of the way we query the database in MVC frameworks and as the Rails docs put it, it&rsquo;s a part of the M of MVC.</p>



<p>Rails&rsquo; ORM library is called ActiveRecord and it is how we work with the model structure and its relation to the database as it writes database queries for you and facilitates things like complex joins across tables using Ruby instead of low level <abbr title="Structured Query Language">SQL</abbr>.</p>



<p>So, instead of writing your SQL queries manually like <code>SELECT * FROM books</code>, you can use ActiveRecord to generate the same query using <code>Book.all</code> in Ruby &mdash; and while it may not sound impressive at this point, once you consider data scopes, foreign keys and anything else beyond a simple single-table query, it can get very powerful very quickly and can juggle and generate SQL queries that are beyond any mortal&rsquo;s comprehension.</p>



<p>In a book catalogue like the one I&rsquo;ve been working on in the past couple of years, you can set up scopes, joins and includes &mdash; so if I call <code>Book.current.for_web.by_category(1)</code> from Ruby, it will generate a couple of large SQL queries that fetch all books in a specific category of online edition of the current edition of the catalogue along with <em>eager loading</em> relational data such as authors, their roles, different editions of the book and their ISBN numbers, publisher information etc.</p>



<p>So calling <code>Book.current.for_web.by_category(1)</code> in my Rails app will result in those two seriously chonky SQL queries hitting the database server instead of multiple smaller ones, which has serious positive impact on speed and performance:</p>



<pre class="wp-block-code"><code lang="sql" class="language-sql">SELECT DISTINCT "books"."title" AS alias_0, "books"."id" FROM "books" LEFT OUTER JOIN "publishers" ON "publishers"."id" = "books"."publisher_id" LEFT OUTER JOIN "book_categories" ON "book_categories"."book_id" = "books"."id" LEFT OUTER JOIN "categories" ON "categories"."id" = "book_categories"."category_id" LEFT OUTER JOIN "book_authors" ON "book_authors"."book_id" = "books"."id" LEFT OUTER JOIN "authors" ON "authors"."id" = "book_authors"."author_id" LEFT OUTER JOIN "author_types" ON "author_types"."id" = "book_authors"."author_type_id" LEFT OUTER JOIN "book_editions" ON "book_editions"."book_id" = "books"."id" LEFT OUTER JOIN "book_edition_categories" ON "book_edition_categories"."book_edition_id" = "book_editions"."id" LEFT OUTER JOIN "editions" ON "editions"."id" = "book_editions"."edition_id" WHERE "book_editions"."edition_id" IN (SELECT "editions"."id" FROM "editions" WHERE "editions"."online" = TRUE ORDER BY "editions"."id" DESC) AND "book_edition_categories"."for_web" = TRUE AND "book_edition_categories"."category_id" = 1;
SELECT "books"."id" AS t0_r0, "books"."source_id" AS t0_r1, "books"."pre_title" AS t0_r2, "books"."title" AS t0_r3, "books"."post_title" AS t0_r4, "books"."slug" AS t0_r5, "books"."description" AS t0_r6, "books"."long_description" AS t0_r7, "books"."publisher_id" AS t0_r8, "books"."created_at" AS t0_r9, "books"."updated_at" AS t0_r10, "books"."uri_to_buy" AS t0_r11, "books"."uri_to_sample" AS t0_r12, "books"."uri_to_audiobook" AS t0_r13, "books"."title_noshy" AS t0_r14, "books"."title_hypenated" AS t0_r15, "books"."country_of_origin" AS t0_r16, "books"."original_title" AS t0_r17, "books"."cover_image_srcsets" AS t0_r18, "books"."sample_pages_srcsets" AS t0_r19, "books"."original_language" AS t0_r20, "publishers"."id" AS t1_r0, "publishers"."source_id" AS t1_r1, "publishers"."name" AS t1_r2, "publishers"."slug" AS t1_r3, "publishers"."url" AS t1_r4, "publishers"."created_at" AS t1_r5, "publishers"."updated_at" AS t1_r6, "publishers"."email_address" AS t1_r7, "publishers"."kennitala" AS t1_r8, "publishers"."is_member" AS t1_r9, "publishers"."schema_type" AS t1_r10, "categories"."id" AS t2_r0, "categories"."source_id" AS t2_r1, "categories"."origin_name" AS t2_r2, "categories"."slug" AS t2_r3, "categories"."rod" AS t2_r4, "categories"."created_at" AS t2_r5, "categories"."updated_at" AS t2_r6, "categories"."group" AS t2_r7, "categories"."name" AS t2_r8, "categories"."book_count" AS t2_r9, "categories"."book_count_web" AS t2_r10, "categories"."book_count_print" AS t2_r11, "book_authors"."id" AS t3_r0, "book_authors"."source_id" AS t3_r1, "book_authors"."book_id" AS t3_r2, "book_authors"."author_id" AS t3_r3, "book_authors"."author_type_id" AS t3_r4, "book_authors"."created_at" AS t3_r5, "book_authors"."updated_at" AS t3_r6, "authors"."id" AS t4_r0, "authors"."source_id" AS t4_r1, "authors"."firstname" AS t4_r2, "authors"."lastname" AS t4_r3, "authors"."slug" AS t4_r4, "authors"."created_at" AS t4_r5, "authors"."updated_at" AS t4_r6, "authors"."is_icelandic" AS t4_r7, "authors"."order_by_name" AS t4_r8, "authors"."name" AS t4_r9, "authors"."added_by_id" AS t4_r10, "authors"."schema_type" AS t4_r11, "author_types"."id" AS t5_r0, "author_types"."source_id" AS t5_r1, "author_types"."name" AS t5_r2, "author_types"."slug" AS t5_r3, "author_types"."rod" AS t5_r4, "author_types"."created_at" AS t5_r5, "author_types"."updated_at" AS t5_r6, "author_types"."abbreviation" AS t5_r7, "author_types"."plural_name" AS t5_r8, "author_types"."schema_role" AS t5_r9, "book_editions"."id" AS t6_r0, "book_editions"."book_id" AS t6_r1, "book_editions"."edition_id" AS t6_r2, "book_editions"."created_at" AS t6_r3, "book_editions"."updated_at" AS t6_r4, "book_edition_categories"."id" AS t7_r0, "book_edition_categories"."book_edition_id" AS t7_r1, "book_edition_categories"."category_id" AS t7_r2, "book_edition_categories"."for_web" AS t7_r3, "book_edition_categories"."for_print" AS t7_r4, "book_edition_categories"."created_at" AS t7_r5, "book_edition_categories"."updated_at" AS t7_r6, "book_edition_categories"."invoiced" AS t7_r7, "book_edition_categories"."dk_invoice_number" AS t7_r8, "editions"."id" AS t8_r0, "editions"."title" AS t8_r1, "editions"."original_title_id_string" AS t8_r2, "editions"."created_at" AS t8_r3, "editions"."updated_at" AS t8_r4, "editions"."print_date" AS t8_r5, "editions"."closing_date" AS t8_r6, "editions"."opening_date" AS t8_r7, "editions"."online_date" AS t8_r8, "editions"."cover_image_srcsets" AS t8_r9, "editions"."is_legacy" AS t8_r10, "editions"."year" AS t8_r11, "editions"."online" AS t8_r12, "editions"."open_to_web_registrations" AS t8_r13, "editions"."open_to_print_registrations" AS t8_r14 FROM "books" LEFT OUTER JOIN "publishers" ON "publishers"."id" = "books"."publisher_id" LEFT OUTER JOIN "book_categories" ON "book_categories"."book_id" = "books"."id" LEFT OUTER JOIN "categories" ON "categories"."id" = "book_categories"."category_id" LEFT OUTER JOIN "book_authors" ON "book_authors"."book_id" = "books"."id" LEFT OUTER JOIN "authors" ON "authors"."id" = "book_authors"."author_id" LEFT OUTER JOIN "author_types" ON "author_types"."id" = "book_authors"."author_type_id" LEFT OUTER JOIN "book_editions" ON "book_editions"."book_id" = "books"."id" LEFT OUTER JOIN "book_edition_categories" ON "book_edition_categories"."book_edition_id" = "book_editions"."id" LEFT OUTER JOIN "editions" ON "editions"."id" = "book_editions"."edition_id" WHERE "book_editions"."edition_id" IN (SELECT "editions"."id" FROM "editions" WHERE "editions"."online" = TRUE ORDER BY "editions"."id" DESC) AND "book_edition_categories"."for_web" = TRUE AND "book_edition_categories"."category_id" = 1 AND "books"."id" IN (3, 454, 301, 431, 88, 383, 191, 27, 271, 122, 403) ORDER BY "books"."title" ASC</code></pre>



<p>(No, I don&rsquo;t expect anyone in their right mind to put in the energy to analyse or pick apart those SQL queries in any other way than seeing how big and chonky they are.)</p>



<h2 class="wp-block-heading">My Approach</h2>



<p>As a contractor, I try my best not to do things off-the-clock because I have to sell and bill for the work that I do for my clients &mdash; but I must admit that pushing the best possible performance out of my web apps without relying on an external caching service is a serious passion (and distraction) of mine.</p>



<p>For most of my work, I strife to keep 500 ms (that&rsquo;s half a second) as the absolute maximum time that it takes to render a view and with model structures that almost always end up more complicated than originally intended, eager loading to prevent n+1 queries and being sure to index the database properly are the two most important parts to that.</p>



<p>For simple content such as our <a href="https://www.bokatidindi.is/pages/privacy_policy" data-type="link" data-id="https://www.bokatidindi.is/pages/privacy_policy" target="_blank" rel="noreferrer noopener">Cookie and Privacy Policy page</a>, 250 ms (a quarter of a second) should then always be achievable, even on WordPress sites like this one, which renders the main landing page in well under 100 ms and a blog post in something like 125.</p>



<p>And to make it clear, most issues with making performant and scalable web apps and sites is rarely about the framework, platform or the CMS involved being scalable or not &mdash; it is about having a grasp of the inner workings of it and knowing how to avoid unnecessary overhead &mdash; and with that in mind, almost any web development framework that runs from a database can scale.</p>



<h2 class="wp-block-heading">Digging for the Causes</h2>



<p>Now, an almost tenfold increase in loading times on the production instance, not to mention timeout issues in our JSON endpoints is a serious issue.</p>



<p>I had not changed anything in the app itself, so my first thought was to see if the database was properly indexed &mdash; and because migrations had been run during the upgrade, which may have changed something, it was worth the look. However, the indexes were correctly defined, just like they had been.</p>



<p>I do run the <code>pg_prewarm</code> PostgreSQL extension as a cron job every morning to make sure that the indexes are loaded into memory, but checking on it, it was working as expected. No issues detected.</p>



<p>Downgrading and upgrading other dependencies lead nowhere, so it must have been a change in Rails itself that was causing this, but <em>how </em>and <em>where</em>?</p>



<p>Admittedly, I disconnect the site from monitoring services during the low season so now was the time to connect it to AppSignal to see what was really going on. (And admittedly, if you&rsquo;re not using a monitoring service like AppSignal and New Relic, performance analysis is mostly guesswork).</p>



<p>I did not have to wait long to for the results to come in. Let&rsquo;s have a look at this screenshot:</p>



<figure class="wp-block-image size-large"><img fetchpriority="high" decoding="async" width="1024" height="427" src="/wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-01.22.38-1024x427.png" alt="A screenshot from the AppSignal performance interface, showing two SQL queries adding about 700 ms to a timeline of 1.2 seconds." class="wp-image-772" srcset="/wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-01.22.38-1024x427.png 1024w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-01.22.38-300x125.png 300w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-01.22.38-768x320.png 768w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-01.22.38-1536x640.png 1536w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-01.22.38-2048x853.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>See the two long blue lines? Remember the two chonky SQL queries from above?</p>



<p>They had become much bigger and insanely slow for some reason and having a further look, they were taking much longer to execute, causing a significant delay &mdash; but how?</p>



<p>What those queries and others ActiveRecord calls that were killing the site had in common is that they were supposed to be <em>eager loading</em> information about the ActiveStorage attachment each book has such as the front cover, sample pages and audiobook previews.</p>



<p>For the uninitiated, ActiveStorage is how Ruby on Rails keeps file attachments that are then associated with ActiveRecord records, using ActiveRecord. Each attachment can then have variations such as different sized images or different file formats and may be stored in the cloud.</p>



<p>Adding <code>.with_attached_cover_image</code> to the method chain is supposed to add the necessary joins to the resulting database query to <em>eager load</em> information about the image of the front cover of every book, to save on the number of queries.</p>



<p>This was a deliberate choice for my Rails app as it was supposed to save time and overhead, resulting in much quicker processing times (and AppSignal would stop telling me my code was bad) &mdash; but why was it suddenly grinding down to a halt, to the point of breaking the site?</p>



<h2 class="wp-block-heading">You See, They Made it Better</h2>



<p>This all led me down the rabbit hole of looking at ActiveRecord release notes for versions 8.0 down to 7.1 to see what was going on &mdash; <a href="https://github.com/rails/rails/blob/v7.1.0/activestorage/CHANGELOG.md#rails-710beta1-september-13-2023" data-type="link" data-id="https://github.com/rails/rails/blob/v7.1.0/activestorage/CHANGELOG.md#rails-710beta1-september-13-2023">and there it was in version 7.1</a>!</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>Fix variants not included when eager loading multiple records containing a single attachment</p>



<p>When using the <code>with_attached_#{name}</code> scope for a <code>has_one_attached</code> relation, attachment variants were not eagerly loaded.</p>
<cite>Russell Porter</cite></blockquote>



<p>This means that the feature was &ldquo;fixed&rdquo; so that all information about every single variant of each ActiveStorage object is now also <em>eager loaded</em> from the database, which is what caused the SQL queries to explode like this.</p>



<p>The thing is I only needed to <em>eager load</em> basic information like if a book has a picture of its cover attached at all or how many sample pages it had. What I did not intend to eager load was information about every single variant to every image attached to every book, because I was actually <em>lazy loading</em> each image variant like so:</p>



<pre class="wp-block-code"><code lang="ruby" class="language-ruby"># Load the srcset for browsers that support the WebP format
book.cover_image_srcsets['webp']
=&gt; "https://cdn.bokatidindi.is/an8kcwm4chce8ztydmm3f1hq6374 150w, https://cdn.bokatidindi.is/j8gyh6jqtjkmgmjzwalyd23iztm0 260w, https://cdn.bokatidindi.is/q8ei2b2169hie958h2fg7x8it379 550w, https://cdn.bokatidindi.is/3incottl2rdioxwdhhrdm3u748b4 1200w, https://cdn.bokatidindi.is/f5da1w2yh8wr7r0y8nwh862ixzsi 1600w"</code></pre>



<p>Because we&rsquo;re using responsive images, each book&rsquo;s front cover image has 11 different variants &mdash; 5 different sizes for both JPEG and WebP and a single TIFF image that we use for the printed edition &mdash; in addition to 7 different image sizes for each sample page in JPEG and WebP as well as the audio preview.</p>



<p>Now, if each book has on average 2 sample pages, we would be dealing with 25 variants per book and if we&rsquo;re loading out 18 results per page, that&rsquo;s 450 variants in total &mdash; and for our maximum 100 search results we don&rsquo;t need cover images for each results, we may be dealing with 2500 variants, most if which we would not be using at all. And that&rsquo;s a lot.</p>



<p>Now, add the fact that deleting variants wasn&rsquo;t really a thing until version 7.1.</p>



<p>I had known that the variant information wasn&rsquo;t included in the eager loading feature back in Rails version 7.0 and fetching them one-by-one was making things extremely slow, so the image variants for each front cover are actually <em>lazy loaded</em> (but not eager loaded) using static attributes for each book called <code>cover_image_srcsets</code> in order to improve processing times. (This also maps their URLs to their proper location on our CDN instead of linking straight to the cloud bucket storage.)</p>



<p>In other words, the ActiveStorage variant API was (and still is) overly slow and bloated for what it is supposed to achieve and my intention was to bypass it in a smart and efficient way while also using what was then a rudimentary but relatively efficient way to <em>eager load </em>some basic information like if there is a picture of the cover attached.</p>



<p>So by &ldquo;fixing&rdquo; the ActiveStorage API and <em>eager loading</em> all the variants if I call <code>Book.current.for_web.by_category(@category.id).with_attached_cover_image</code> in version 7.1, the Ruby on Rails team managed to add bloat and inefficiencies that were totally unexpected.</p>



<h2 class="wp-block-heading">The Fix</h2>



<p>Sometimes we need to accept that not everything is perfect, so I went ahead and did a project-wide search-and-replace for any <code>.with_attached_cover_image</code> statement and removed each and every single one of them.</p>



<p>This will result in more n+1 queries on the site but it has already resulted in a considerable performance improvement and it is as close enough to the original performance figures.</p>



<figure class="wp-block-image size-large"><img decoding="async" width="1024" height="415" src="/wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-03.27.30-1024x415.png" alt="Two line graphs from AppSignal, showing a substantial performance improvement between July 19 and 20." class="wp-image-807" srcset="/wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-03.27.30-1024x415.png 1024w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-03.27.30-300x122.png 300w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-03.27.30-768x311.png 768w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-03.27.30-1536x623.png 1536w, /wp-content/uploads/2025/07/Screen-Shot-2025-07-21-at-03.27.30-2048x830.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>Looking at he AppSignal graphs for the site, we can see that the mean response time went from about 600 ms at its peak for one controller action that use <code>.with_attached_cover_image</code> statement, down to 70-170 ms.</p>



<h2 class="wp-block-heading">The Lesson</h2>



<p>While Ruby on Rails does facilitate best practices in general and in particular the prevention of n+1 queries, which can be a considerable performance bottleneck, depending on catch-all solutions may break things in unexpected ways.</p>



<p>Furthermore, reading the release notes and browsing the source code for the framework or CMS we use &mdash; or any other dependency for that matter &mdash; is probably the best way to trace the unexpected issues we are dealing with during upgrades as not everything makes it to blog posts, social media or official documentation.</p>



<p>Lastly, we need to be more eager to perform periodical updates for client projects. Regular periodical maintenance may not add extra features to your app or improve performance, but developers need to have the confidence to educate clients about the importance of incremental framework and dependency upgrades instead of rushing in at the end-of-life.</p>
</div>
    </article>



    <aside class="wp-block-group author-info is-layout-flow wp-block-group-is-layout-flow">
    <div class="wp-block-post-author has-medium-font-size"><div class="wp-block-post-author__avatar"><img alt="" src="https://secure.gravatar.com/avatar/4ccdaeb5f30a50947d0a51a9d347be281d1885d1cdd10e8180640b7dff557749?s=192&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4ccdaeb5f30a50947d0a51a9d347be281d1885d1cdd10e8180640b7dff557749?s=384&amp;d=mm&amp;r=g 2x" class="avatar avatar-192 photo" height="192" width="192" decoding="async"></div><div class="wp-block-post-author__content"><p class="wp-block-post-author__name">Alda Vigd&iacute;s Skarph&eacute;&eth;insd&oacute;ttir</p><p class="wp-block-post-author__bio">Having made things for the web since the 90&rsquo;s, Alda has found herself in the position of being a jack of all trades when it comes to full stack web development and system operations. She&rsquo;s currently consulting in the hosting sector and open to new opportunities.</p></div></div>
    </aside>


<div class="site-footer wp-block-template-part">
    <footer class="wp-block-group has-s-font-size is-layout-constrained wp-block-group-is-layout-constrained">
    <p class="has-s-font-size">
        This is a project by
        <a href="https://aldavigdis.is/" target="_blank">Alda Vigd&iacute;s</a>.
    </p>
    
    </footer>

</div>
</div>
<script type="speculationrules">
{"prefetch":[{"source":"document","where":{"and":[{"href_matches":"\/*"},{"not":{"href_matches":["\/wp-*.php","\/wp-admin\/*","\/wp-content\/uploads\/*","\/wp-content\/*","\/wp-content\/plugins\/*","\/wp-content\/themes\/aldatheme\/*","\/*\\?(.+)"]}},{"not":{"selector_matches":"a[rel~=\"nofollow\"]"}},{"not":{"selector_matches":".no-prefetch, .no-prefetch a"}}]},"eagerness":"conservative"}]}
</script>
<script id="wp-block-template-skip-link-js-after">
	( function() {
		var skipLinkTarget = document.querySelector( 'main' ),
			sibling,
			skipLinkTargetID,
			skipLink;

		// Early exit if a skip-link target can't be located.
		if ( ! skipLinkTarget ) {
			return;
		}

		/*
		 * Get the site wrapper.
		 * The skip-link will be injected in the beginning of it.
		 */
		sibling = document.querySelector( '.wp-site-blocks' );

		// Early exit if the root element was not found.
		if ( ! sibling ) {
			return;
		}

		// Get the skip-link target's ID, and generate one if it doesn't exist.
		skipLinkTargetID = skipLinkTarget.id;
		if ( ! skipLinkTargetID ) {
			skipLinkTargetID = 'wp--skip-link--target';
			skipLinkTarget.id = skipLinkTargetID;
		}

		// Create the skip link.
		skipLink = document.createElement( 'a' );
		skipLink.classList.add( 'skip-link', 'screen-reader-text' );
		skipLink.id = 'wp-skip-link';
		skipLink.href = '#' + skipLinkTargetID;
		skipLink.innerText = 'Skip to content';

		// Inject the skip link.
		sibling.parentElement.insertBefore( skipLink, sibling );
	}() );
	
</script>
<script id="mkaz-code-syntax-prism-js-js-extra">
var prism_settings = {"pluginUrl":"\/wp-content\/plugins\/code-syntax-block\/"};
</script>
<script src="/wp-content/plugins/code-syntax-block/assets/prism/prism.js?ver=1727704537" id="mkaz-code-syntax-prism-js-js"></script>
</body>
</html>
